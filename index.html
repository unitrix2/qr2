<!DOCTYPE html><html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web QR Code Enhancer</title>
  <!-- Tailwind (CDN JIT) for a modern glassy UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            glass: 'rgba(255,255,255,0.12)',
            ink: '#0f172a'
          },
          boxShadow: {
            glow: '0 10px 30px rgba(0,0,0,0.25)'
          },
          backdropBlur: {
            xs: '2px'
          }
        }
      }
    }
  </script>
  <style>
    html, body { background: radial-gradient(1200px 600px at 10% 10%, #0b1220, #0a0f1a 45%, #070b13); color: #e8eef9; }
    .glass { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.16); backdrop-filter: blur(8px); }
    .chip { background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.16); }
    .scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
    .scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 999px; }
    .scrollbar::-webkit-scrollbar-track { background: transparent; }
  </style>
  <!-- ZXing for QR decode -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <!-- qr-code-styling for SVG generation -->
  <script src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF + autotable for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 glass shadow-glow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold tracking-tight">QR Code Enhancer</h1>
      <div class="flex items-center gap-2 text-xs opacity-80">
        <span class="px-2 py-1 chip rounded-full">100% Client-side</span>
        <span class="px-2 py-1 chip rounded-full">SVG→PNG/JPG</span>
        <span class="px-2 py-1 chip rounded-full">Live Preview</span>
      </div>
    </div>
  </header>  <!-- Main layout -->  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left: Controls -->
    <section class="lg:col-span-4 glass rounded-2xl p-4 shadow-glow">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Inputs & Settings</h2>
        <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
          <input id="darkToggle" type="checkbox" class="accent-cyan-400" checked>
          <span>Glassy Dark</span>
        </label>
      </div><!-- File input -->
  <div class="space-y-3">
    <label class="block text-sm opacity-90">Upload multiple QR images (JPG/PNG/SVG, etc.)</label>
    <input id="fileInput" type="file" accept="image/*,.svg" multiple class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-500/20 file:text-cyan-200 hover:file:bg-cyan-500/30" />
    <p class="text-xs opacity-70">Tip: Drag & drop भी कर सकते हैं।</p>
  </div>

  <hr class="my-4 border-white/10"/>

  <!-- Global caption -->
  <div class="space-y-2">
    <label class="text-sm">Global Caption</label>
    <input id="globalCaption" type="text" placeholder="उदा. ABC" class="w-full glass rounded-xl px-3 py-2 outline-none" />
    <p class="text-xs opacity-70">ये caption सभी entries पर auto-apply होगा; table में specific entry पर बदल सकते हैं।</p>
  </div>

  <hr class="my-4 border-white/10"/>

  <!-- Size & quality -->
  <div class="grid grid-cols-2 gap-3">
    <div>
      <label class="text-sm">QR Size</label>
      <div class="flex gap-2 mt-1">
        <input id="qrSizeValue" type="number" value="256" min="64" class="w-full glass rounded-xl px-3 py-2 outline-none" />
        <select id="qrSizeUnit" class="glass rounded-xl px-2">
          <option value="px">px</option>
          <option value="mm">mm</option>
        </select>
      </div>
    </div>
    <div>
      <label class="text-sm">PNG/JPG DPI</label>
      <input id="dpi" type="number" value="300" min="72" class="w-full glass rounded-xl px-3 py-2 outline-none" />
    </div>
  </div>

  <hr class="my-4 border-white/10"/>

  <!-- Code (6 letters) styling -->
  <details class="glass rounded-xl p-3" open>
    <summary class="cursor-pointer select-none font-medium">Code Styling (link के बाद 6 letters)</summary>
    <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
      <div>
        <label>Font Family</label>
        <select id="codeFont" class="glass rounded-xl px-2 py-1 w-full">
          <option>Inter</option>
          <option>Montserrat</option>
          <option>Roboto Mono</option>
          <option>Nunito</option>
        </select>
      </div>
      <div>
        <label>Font Size (pt)</label>
        <input id="codeFontSize" type="number" value="12" min="6" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Weight</label>
        <select id="codeWeight" class="glass rounded-xl px-2 py-1 w-full">
          <option value="400">Normal</option>
          <option value="600">SemiBold</option>
          <option value="700" selected>Bold</option>
        </select>
      </div>
      <div>
        <label>Style</label>
        <select id="codeStyle" class="glass rounded-xl px-2 py-1 w-full">
          <option value="normal">Normal</option>
          <option value="italic">Italic</option>
        </select>
      </div>
      <div>
        <label>Code-QR Gap (mm)</label>
        <input id="gapCode" type="number" value="2" min="0" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Text Color</label>
        <input id="codeColor" type="color" value="#e8eef9" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
    </div>
  </details>

  <details class="glass rounded-xl p-3 mt-3" open>
    <summary class="cursor-pointer select-none font-medium">Caption Styling</summary>
    <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
      <div>
        <label>Font Family</label>
        <select id="capFont" class="glass rounded-xl px-2 py-1 w-full">
          <option>Inter</option>
          <option>Montserrat</option>
          <option>Roboto Mono</option>
          <option>Nunito</option>
        </select>
      </div>
      <div>
        <label>Font Size (pt)</label>
        <input id="capFontSize" type="number" value="10" min="6" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Weight</label>
        <select id="capWeight" class="glass rounded-xl px-2 py-1 w-full">
          <option value="400" selected>Normal</option>
          <option value="600">SemiBold</option>
          <option value="700">Bold</option>
        </select>
      </div>
      <div>
        <label>Style</label>
        <select id="capStyle" class="glass rounded-xl px-2 py-1 w-full">
          <option value="normal" selected>Normal</option>
          <option value="italic">Italic</option>
        </select>
      </div>
      <div>
        <label>Code-Caption Gap (mm)</label>
        <input id="gapCaption" type="number" value="1.5" min="0" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Text Color</label>
        <input id="capColor" type="color" value="#c7d2fe" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
    </div>
    <div class="mt-3 flex items-center gap-2 text-sm">
      <input id="lineToggle" type="checkbox" class="accent-cyan-400" />
      <label>Code और Caption के बीच लाइन जोड़ें</label>
    </div>
    <div id="lineOptions" class="mt-2 grid grid-cols-2 gap-3 text-sm hidden">
      <div>
        <label>Line Thickness (px)</label>
        <input id="lineThickness" type="number" value="1" min="0" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Line Color</label>
        <input id="lineColor" type="color" value="#94a3b8" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Line Length (% of QR)</label>
        <input id="lineLength" type="number" value="100" min="10" max="120" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Gap: Code→Line (mm)</label>
        <input id="gapCodeLine" type="number" value="1" min="0" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
      <div>
        <label>Gap: Line→Caption (mm)</label>
        <input id="gapLineCaption" type="number" value="1" min="0" class="glass rounded-xl px-2 py-1 w-full"/>
      </div>
    </div>
  </details>

  <hr class="my-4 border-white/10"/>

  <!-- Export buttons -->
  <div class="flex flex-wrap gap-2">
    <button id="exportExcel" class="px-3 py-2 rounded-xl bg-emerald-500/20 hover:bg-emerald-500/30">Export Excel</button>
    <button id="exportCSV" class="px-3 py-2 rounded-xl bg-cyan-500/20 hover:bg-cyan-500/30">Export CSV</button>
    <button id="exportPDF" class="px-3 py-2 rounded-xl bg-indigo-500/20 hover:bg-indigo-500/30">Export PDF</button>
    <button id="downloadAll" class="px-3 py-2 rounded-xl bg-fuchsia-500/20 hover:bg-fuchsia-500/30">Download All</button>
  </div>

  <p class="text-[11px] opacity-60 mt-3">Note: PNG/JPG रेंडरिंग आपकी DPI सेटिंग और px/mm conversion (96 DPI, 3.78 px/mm) के अनुसार होगी।</p>
</section>

<!-- Right: Previews + Table -->
<section class="lg:col-span-8 space-y-6">
  <!-- Previews -->
  <div class="glass rounded-2xl p-4 shadow-glow">
    <h2 class="text-lg font-semibold mb-2">Preview</h2>
    <div class="text-sm opacity-80 mb-3">ऊपर: सभी input QR • नीचे: Enhanced output (live)</div>
    <div class="space-y-4">
      <div id="inputRow" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
      <div id="outputRow" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <!-- Data Table -->
  <div class="glass rounded-2xl p-4 shadow-glow">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Data Table</h2>
      <div class="text-xs opacity-70">Sr. No. • Code • Caption • FE No. • QR Link/Text</div>
    </div>
    <div id="tableWrap" class="overflow-auto scrollbar">
      <table id="dataTable" class="w-full text-sm">
        <thead class="text-left border-b border-white/10">
          <tr class="opacity-80">
            <th class="py-2 pr-2">Sr.</th>
            <th class="py-2 pr-2">Code</th>
            <th class="py-2 pr-2">Caption</th>
            <th class="py-2 pr-2">FE No.</th>
            <th class="py-2 pr-2">QR Link/Text</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</section>

  </main>  <!-- Fonts for preview options -->  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@400;600;700&family=Nunito:wght@400;600;700&family=Roboto+Mono:wght@400;600;700&display=swap" rel="stylesheet">  <script>
    // ---- Utilities ----
    const mmToPx = (mm) => mm * 3.78; // assuming 96DPI
    const ptToPx = (pt) => pt * (96 / 72);

    function extractCodeFromLink(text) {
      // Finds last 6 alphabetic letters after '=' at the end or before separators
      // Examples: ...=ABCDEF -> ABCDEF | ...=abc123 (ignored) | ...=ZZZZZZ&x=y -> ZZZZZZ
      const match = text.match(/=([A-Za-z]{6})(?![A-Za-z0-9])/);
      return match ? match[1] : '';
    }

    function downloadBlob(filename, dataUrl) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function svgToDataURL(svgNode) {
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(svgNode);
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);
    }

    function renderSVGtoCanvas(svgNode, pxSize, mimeType = 'image/png', dpi = 300) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = pxSize; canvas.height = pxSize;
          const ctx = canvas.getContext('2d');
          // white background for JPG
          if (mimeType === 'image/jpeg') {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,canvas.width,canvas.height);
          }
          ctx.drawImage(img, 0, 0, pxSize, pxSize);
          // Set DPI via metadata is not standard cross-browser; use pixel size to achieve resolution.
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            resolve(url);
          }, mimeType, 1);
        };
        img.onerror = reject;
        img.src = svgToDataURL(svgNode);
      });
    }

    // ---- State ----
    const state = {
      entries: [], // { id, fileName, inputUrl, text, code, caption, fe, qr, svgNode, domRefs }
      options: {
        size: 256, sizeUnit: 'px', dpi: 300,
        code: { font: 'Inter', sizePt: 12, weight: 700, style: 'normal', color: '#e8eef9', gapMM: 2 },
        cap: { font: 'Inter', sizePt: 10, weight: 400, style: 'normal', color: '#c7d2fe', gapMM: 1.5 },
        line: { enabled: false, thickness: 1, color: '#94a3b8', lengthPct: 100, gapCodeMM: 1, gapCapMM: 1 }
      },
      globalCaption: ''
    };

    // ---- DOM refs ----
    const fileInput = document.getElementById('fileInput');
    const inputRow = document.getElementById('inputRow');
    const outputRow = document.getElementById('outputRow');
    const tableBody = document.getElementById('tableBody');

    // Controls
    const qrSizeValue = document.getElementById('qrSizeValue');
    const qrSizeUnit = document.getElementById('qrSizeUnit');
    const dpiInput = document.getElementById('dpi');

    const codeFont = document.getElementById('codeFont');
    const codeFontSize = document.getElementById('codeFontSize');
    const codeWeight = document.getElementById('codeWeight');
    const codeStyle = document.getElementById('codeStyle');
    const codeColor = document.getElementById('codeColor');
    const gapCode = document.getElementById('gapCode');

    const capFont = document.getElementById('capFont');
    const capFontSize = document.getElementById('capFontSize');
    const capWeight = document.getElementById('capWeight');
    const capStyle = document.getElementById('capStyle');
    const capColor = document.getElementById('capColor');
    const gapCaption = document.getElementById('gapCaption');

    const lineToggle = document.getElementById('lineToggle');
    const lineOptions = document.getElementById('lineOptions');
    const lineThickness = document.getElementById('lineThickness');
    const lineColor = document.getElementById('lineColor');
    const lineLength = document.getElementById('lineLength');
    const gapCodeLine = document.getElementById('gapCodeLine');
    const gapLineCaption = document.getElementById('gapLineCaption');

    const globalCaption = document.getElementById('globalCaption');

    const exportExcel = document.getElementById('exportExcel');
    const exportCSV = document.getElementById('exportCSV');
    const exportPDF = document.getElementById('exportPDF');
    const downloadAll = document.getElementById('downloadAll');

    // ---- Event wiring ----
    function setLiveHandlers() {
      const change = () => { readControlsIntoState(); rerenderAll(); };
      [qrSizeValue, qrSizeUnit, dpiInput,
       codeFont, codeFontSize, codeWeight, codeStyle, codeColor, gapCode,
       capFont, capFontSize, capWeight, capStyle, capColor, gapCaption,
       lineToggle, lineThickness, lineColor, lineLength, gapCodeLine, gapLineCaption,
       globalCaption
      ].forEach(el => el.addEventListener('input', change));

      lineToggle.addEventListener('change', () => {
        lineOptions.classList.toggle('hidden', !lineToggle.checked);
        change();
      });
    }

    function readControlsIntoState() {
      state.options.size = parseFloat(qrSizeValue.value || '256');
      state.options.sizeUnit = qrSizeUnit.value;
      state.options.dpi = parseInt(dpiInput.value || '300');

      state.options.code.font = codeFont.value;
      state.options.code.sizePt = parseFloat(codeFontSize.value || '12');
      state.options.code.weight = parseInt(codeWeight.value);
      state.options.code.style = codeStyle.value;
      state.options.code.color = codeColor.value;
      state.options.code.gapMM = parseFloat(gapCode.value || '0');

      state.options.cap.font = capFont.value;
      state.options.cap.sizePt = parseFloat(capFontSize.value || '10');
      state.options.cap.weight = parseInt(capWeight.value);
      state.options.cap.style = capStyle.value;
      state.options.cap.color = capColor.value;
      state.options.cap.gapMM = parseFloat(gapCaption.value || '0');

      state.options.line.enabled = lineToggle.checked;
      state.options.line.thickness = parseFloat(lineThickness.value || '1');
      state.options.line.color = lineColor.value;
      state.options.line.lengthPct = parseFloat(lineLength.value || '100');
      state.options.line.gapCodeMM = parseFloat(gapCodeLine.value || '0');
      state.options.line.gapCapMM = parseFloat(gapLineCaption.value || '0');

      state.globalCaption = globalCaption.value || '';
    }

    // ---- Core: create output SVG (QR + code + optional line + caption) ----
    async function buildOutputSVG(entry) {
      const opts = state.options;
      const pxSize = opts.sizeUnit === 'mm' ? Math.round(mmToPx(opts.size)) : Math.round(opts.size);

      // 1) Make QR SVG using qr-code-styling
      const qr = new QRCodeStyling({
        type: 'svg', data: entry.text || ' ', width: pxSize, height: pxSize,
        margin: 0, qrOptions: { typeNumber: 0, errorCorrectionLevel: 'M' },
        dotsOptions: { type: 'square', color: '#000' },
        backgroundOptions: { color: '#ffffff' }
      });
      const qrWrapper = document.createElement('div');
      await qr.append(qrWrapper);
      const qrSvg = qrWrapper.querySelector('svg');

      // 2) Compose a new SVG that stacks: QR -> gap -> code -> optional line -> gap -> caption
      const codeText = entry.code || '';
      const capText = (entry.caption ?? state.globalCaption || '') + (entry.fe ? String(entry.fe) : '');

      // Measure text height (approx) using pt to px
      const codePx = ptToPx(opts.code.sizePt);
      const capPx = ptToPx(opts.cap.sizePt);

      const gapCodePx = Math.round(mmToPx(opts.code.gapMM));
      const gapBetweenCodeAndLine = Math.round(mmToPx(opts.line.gapCodeMM));
      const gapBetweenLineAndCap = Math.round(mmToPx(opts.line.gapCapMM));
      const gapCapPx = Math.round(mmToPx(opts.cap.gapMM));

      let extraHeight = gapCodePx + codePx + gapCapPx + capPx;
      let lineHeight = 0;
      if (opts.line.enabled) {
        lineHeight = opts.line.thickness;
        extraHeight += gapBetweenCodeAndLine + lineHeight + gapBetweenLineAndCap;
      }

      const totalW = pxSize;
      const totalH = pxSize + extraHeight;

      // Container SVG
      const out = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      out.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      out.setAttribute('width', totalW);
      out.setAttribute('height', totalH);
      out.setAttribute('viewBox', 0 0 ${totalW} ${totalH});
      out.style.background = '#ffffff';

      // import QR group
      const gQR = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      gQR.innerHTML = qrSvg.outerHTML; // safe here since created by library
      out.appendChild(gQR);

      // Y cursor starts after QR
      let y = pxSize + gapCodePx;

      // Code text
      if (codeText) {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', String(totalW / 2));
        text.setAttribute('y', String(y + codePx));
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', opts.code.color);
        text.setAttribute('font-family', opts.code.font);
        text.setAttribute('font-size', opts.code.sizePt + 'pt');
        text.setAttribute('font-weight', String(opts.code.weight));
        text.setAttribute('font-style', opts.code.style);
        text.textContent = codeText;
        out.appendChild(text);
        y += codePx;
      }

      // Optional line
      if (opts.line.enabled) {
        y += gapBetweenCodeAndLine;
        const lineLen = Math.min(1.2, Math.max(0.1, opts.line.lengthPct / 100)) * totalW;
        const x1 = (totalW - lineLen) / 2;
        const x2 = x1 + lineLen;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', String(x1));
        line.setAttribute('x2', String(x2));
        line.setAttribute('y1', String(y + lineHeight / 2));
        line.setAttribute('y2', String(y + lineHeight / 2));
        line.setAttribute('stroke', opts.line.color);
        line.setAttribute('stroke-width', String(lineHeight));
        out.appendChild(line);
        y += lineHeight + gapBetweenLineAndCap;
      }

      // Caption text
      if (capText) {
        y += gapCapPx;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', String(totalW / 2));
        text.setAttribute('y', String(y + capPx));
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', opts.cap.color);
        text.setAttribute('font-family', opts.cap.font);
        text.setAttribute('font-size', opts.cap.sizePt + 'pt');
        text.setAttribute('font-weight', String(opts.cap.weight));
        text.setAttribute('font-style', opts.cap.style);
        text.textContent = capText;
        out.appendChild(text);
        y += capPx;
      }

      entry.svgNode = out;
      return out;
    }

    // ---- Renderers ----
    function addInputPreview(entry) {
      const card = document.createElement('div');
      card.className = 'glass rounded-xl p-2 flex flex-col gap-2 items-center';
      const img = document.createElement('img');
      img.src = entry.inputUrl;
      img.alt = entry.fileName;
      img.className = 'w-full aspect-square object-contain rounded-lg bg-white';
      const cap = document.createElement('div');
      cap.className = 'text-xs opacity-75 truncate w-full text-center';
      cap.textContent = entry.fileName;
      card.appendChild(img); card.appendChild(cap);
      inputRow.appendChild(card);
      entry.domRefs = entry.domRefs || {};
      entry.domRefs.inputCard = card;
    }

    function addOutputPreview(entry) {
      const card = document.createElement('div');
      card.className = 'glass rounded-2xl p-3 flex flex-col gap-2';

      const mount = document.createElement('div');
      mount.className = 'w-full rounded-lg overflow-hidden bg-white flex items-center justify-center';

      const btnRow = document.createElement('div');
      btnRow.className = 'flex flex-wrap gap-2 mt-2';

      const chip = document.createElement('div');
      chip.className = 'chip px-2 py-1 rounded-full text-xs self-start';
      chip.textContent = 'Code: ' + (entry.code || '-');

      const btnSVG = document.createElement('button');
      btnSVG.className = 'px-3 py-1 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 text-sm';
      btnSVG.textContent = 'Download SVG';

      const btnPNG = document.createElement('button');
      btnPNG.className = 'px-3 py-1 rounded-lg bg-cyan-500/20 hover:bg-cyan-500/30 text-sm';
      btnPNG.textContent = 'Download PNG';

      const btnJPG = document.createElement('button');
      btnJPG.className = 'px-3 py-1 rounded-lg bg-indigo-500/20 hover:bg-indigo-500/30 text-sm';
      btnJPG.textContent = 'Download JPG';

      btnRow.append(btnSVG, btnPNG, btnJPG);
      card.append(mount, btnRow, chip);
      outputRow.appendChild(card);

      entry.domRefs = entry.domRefs || {};
      entry.domRefs.outputMount = mount;
      entry.domRefs.btnSVG = btnSVG;
      entry.domRefs.btnPNG = btnPNG;
      entry.domRefs.btnJPG = btnJPG;
      entry.domRefs.codeChip = chip;
    }

    async function renderOutput(entry) {
      if (!entry.domRefs || !entry.domRefs.outputMount) return;
      entry.domRefs.outputMount.innerHTML = '';
      const svg = await buildOutputSVG(entry);
      entry.domRefs.outputMount.appendChild(svg);
      entry.domRefs.codeChip.textContent = 'Code: ' + (entry.code || '-');

      // Wire download buttons
      const getPxSize = () => state.options.sizeUnit === 'mm' ? Math.round(mmToPx(state.options.size)) : Math.round(state.options.size);
      entry.domRefs.btnSVG.onclick = () => {
        const dataUrl = svgToDataURL(svg);
        const name = (entry.code || 'qr') + '.svg';
        downloadBlob(name, dataUrl);
      };
      entry.domRefs.btnPNG.onclick = async () => {
        const url = await renderSVGtoCanvas(svg, getPxSize(), 'image/png', state.options.dpi);
        const a = document.createElement('a');
        a.href = url; a.download = (entry.code || 'qr') + '.png';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      };
      entry.domRefs.btnJPG.onclick = async () => {
        const url = await renderSVGtoCanvas(svg, getPxSize(), 'image/jpeg', state.options.dpi);
        const a = document.createElement('a');
        a.href = url; a.download = (entry.code || 'qr') + '.jpg';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      };
    }

    function rerenderAll() {
      state.entries.forEach(renderOutput);
    }

    // ---- Table ----
    function refreshTable() {
      tableBody.innerHTML = '';
      state.entries.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-white/5 hover:bg-white/5';
        const tdSr = <td class="py-2 pr-2">${idx + 1}</td>;
        const tdCode = <td class="py-2 pr-2">${e.code || '-'}</td>;
        const tdCaption = document.createElement('td');
        tdCaption.className = 'py-2 pr-2';
        const capInput = document.createElement('input');
        capInput.type = 'text';
        capInput.value = e.caption ?? '';
        capInput.placeholder = '(auto)';
        capInput.className = 'glass rounded-lg px-2 py-1 w-40';
        capInput.addEventListener('input', () => { e.caption = capInput.value; renderOutput(e); });
        tdCaption.appendChild(capInput);

        const tdFe = document.createElement('td');
        tdFe.className = 'py-2 pr-2';
        const feInput = document.createElement('input');
        feInput.type = 'text'; feInput.value = e.fe ?? ''; feInput.placeholder = '1';
        feInput.className = 'glass rounded-lg px-2 py-1 w-16';
        feInput.addEventListener('input', () => { e.fe = feInput.value; renderOutput(e); });
        tdFe.appendChild(feInput);

        const tdText = <td class="py-2 pr-2 text-ellipsis">${e.text.replaceAll('<','&lt;')}</td>;

        tr.innerHTML = tdSr + tdCode + tdText;
        // Insert editable tds at correct positions
        tr.insertBefore(tdCaption, tr.children[2]);
        tr.insertBefore(tdFe, tr.children[3]);
        tableBody.appendChild(tr);
      });
    }

    // ---- Decode uploaded images ----
    async function decodeImageFile(file) {
      const url = URL.createObjectURL(file);
      try {
        // If SVG, try to pull the embedded text (fallback to raster decode by drawing)
        if (file.type === 'image/svg+xml' || file.name.endsWith('.svg')) {
          const txt = await (await fetch(url)).text();
          // naive: search for QR data embedded – often not present. Fallback below.
        }

        const img = document.createElement('img');
        img.decoding = 'async'; img.src = url;
        await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

        // Use ZXing to decode
        const reader = new ZXingBrowser.BrowserQRCodeReader();
        const result = await reader.decodeFromImage(img);
        return { text: result.text, inputUrl: url };
      } catch (err) {
        console.warn('Decode failed for', file.name, err);
        return { text: '', inputUrl: url };
      }
    }

    async function handleFiles(files) {
      const list = Array.from(files).filter(f => /image\/.+|\.svg$/i.test(f.type) || /\.svg$/i.test(f.name));
      for (const file of list) {
        const { text, inputUrl } = await decodeImageFile(file);
        const code = extractCodeFromLink(text || '');
        const entry = { id: crypto.randomUUID(), fileName: file.name, inputUrl, text: text || '', code, caption: undefined, fe: '' };
        state.entries.push(entry);
        addInputPreview(entry);
        addOutputPreview(entry);
        await renderOutput(entry);
      }
      refreshTable();
    }

    // Drag & drop
    document.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    document.addEventListener('drop', (e)=>{ e.preventDefault(); if (e.dataTransfer?.files?.length) handleFiles(e.dataTransfer.files); });

    fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));

    // Global caption propagate
    globalCaption.addEventListener('input', () => { rerenderAll(); });

    // Export handlers
    exportExcel.addEventListener('click', () => {
      const rows = state.entries.map((e, i) => ({
        'Sr. No.': i+1,
        'Code': e.code || '',
        'Caption': (e.caption ?? state.globalCaption || '') + (e.fe ? String(e.fe) : ''),
        'FE No.': e.fe || '',
        'QR link/text': e.text || ''
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'QR Data');
      XLSX.writeFile(wb, 'qr-data.xlsx');
    });

    exportCSV.addEventListener('click', () => {
      const rows = [['Sr. No.','Code','Caption','FE No.','QR link/text']];
      state.entries.forEach((e,i)=>{
        rows.push([i+1, e.code || '', (e.caption ?? state.globalCaption || '') + (e.fe ? String(e.fe) : ''), e.fe || '', e.text || '']);
      });
      const csv = rows.map(r=> r.map(v=> '"'+String(v).replaceAll('"','""')+'"').join(',')).join('\n');
      const url = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      downloadBlob('qr-data.csv', url);
    });

    exportPDF.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const data = state.entries.map((e,i)=>[
        i+1,
        e.code || '',
        (e.caption ?? state.globalCaption || '') + (e.fe ? String(e.fe) : ''),
        e.fe || '',
        e.text || ''
      ]);
      doc.text('QR Data', 40, 40);
      doc.autoTable({ startY: 60, head: [['Sr. No.','Code','Caption','FE No.','QR link/text']], body: data, styles: { fontSize: 9 }});
      doc.save('qr-data.pdf');
    });

    downloadAll.addEventListener('click', async () => {
      // Bundle as individual downloads; for large batches consider Zip (JSZip) – omitted to keep size small
      for (const e of state.entries) {
        await renderOutput(e);
        const svg = e.svgNode;
        const base = e.code || 'qr';
        downloadBlob(base + '.svg', svgToDataURL(svg));
        const px = state.options.sizeUnit === 'mm' ? Math.round(mmToPx(state.options.size)) : Math.round(state.options.size);
        const pngUrl = await renderSVGtoCanvas(svg, px, 'image/png', state.options.dpi);
        const a1 = document.createElement('a'); a1.href = pngUrl; a1.download = base + '.png'; document.body.appendChild(a1); a1.click(); a1.remove(); setTimeout(()=>URL.revokeObjectURL(pngUrl), 1000);
        const jpgUrl = await renderSVGtoCanvas(svg, px, 'image/jpeg', state.options.dpi);
        const a2 = document.createElement('a'); a2.href = jpgUrl; a2.download = base + '.jpg'; document.body.appendChild(a2); a2.click(); a2.remove(); setTimeout(()=>URL.revokeObjectURL(jpgUrl), 1000);
      }
    });

    // Theme toggle (simple demo)
    document.getElementById('darkToggle').addEventListener('change', (e)=>{
      document.body.style.background = e.target.checked ? 'radial-gradient(1200px 600px at 10% 10%, #0b1220, #0a0f1a 45%, #070b13)' : '#f5f7fb';
    });

    // Init
    setLiveHandlers();
    readControlsIntoState();
  </script></body>
</html>
